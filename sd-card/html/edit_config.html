<!DOCTYPE html>
<html>
<head>
<link rel="icon" href="favicon.ico?v=$COMMIT_HASH" type="image/x-icon">
<title>Edit Config</title>
<meta charset="utf-8">

<style>
h1 {font-size: 2em;}
h2 {font-size: 1.5em; margin-block-start: 0.0em; margin-block-end: 0.2em;}
h3 {font-size: 1.2em;}
p {font-size: 1em;}

.button {
	padding: 5px 20px;
    width: 211px;
	font-size: 16px;	
}

textarea {
	font-size: 14px;
}
</style>
<link href="firework.css?v=$COMMIT_HASH" rel="stylesheet">
<script type="text/javascript" src="jquery-3.6.0.min.js?v=$COMMIT_HASH"></script>  
<script type="text/javascript" src="firework.js?v=$COMMIT_HASH"></script>
</head>

<body style="font-family: arial; padding: 0px 10px;">
 
<table>
    <tr><td><h2>Config.ini:</h2></td></tr>
    <tr>
        <td colspan="3">
            <textarea id="inputTextToSave" cols="100" rows="31"></textarea>
        </td>
    </tr>
    <tr>
		<td><button class="button" onclick="saveTextAsFile()">Save and apply</button></td>
	</tr>
	<tr>
		<td><button class="button" id="reboot" type="button" onclick="doReboot()">Reboot device</button></td>
	</tr>
</table>

<script type="text/javascript" src="common.js?v=$COMMIT_HASH"></script> 
<script type="text/javascript" src="readconfigcommon.js?v=$COMMIT_HASH"></script>  
 
<script type="text/javascript">
	var canvas = document.getElementById('canvas'),
		domainname = getDomainname(); 


function LoadConfigNeu() {
	domainname = getDomainname();  
    loadConfig(domainname); 	
	document.getElementById("inputTextToSave").value = getConfig();
	}

function saveTextAsFile()
{
	if (confirm("Are you sure you want to update the configuration?")) {
		FileDeleteOnServer("/config/config.ini", domainname);
		var textToSave = document.getElementById("inputTextToSave").value;
		FileSendContent(textToSave, "/config/config.ini", domainname);

		firework.launch('Apply configuration...', 'success', 5000);
		setTimeout(function() {
			reload_config();
        }, 1000);    
	}
}

function doReboot() {
	if (confirm("Are you sure you want to reboot the ESP32?")) {
		var stringota = domainname + "/reboot";
		window.location = stringota;
		window.location.href = stringota;
		window.location.assign(stringota);
		window.location.replace(stringota);
	}
}

function reload_config() {
		var url = getDomainname() + '/reload_config';     
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {	
			if (this.readyState == 4 && this.status == 200) {
				if (xhttp.responseText.substring(0,3) == "001" || xhttp.responseText.substring(0,3) == "002" || xhttp.responseText.substring(0,3) == "003") {
					firework.launch('Configuration updated and applied', 'success', 5000);
				}
				else if (xhttp.responseText.substring(0,3) == "004") {
					firework.launch('Configuration updated and get applied after round is completed', 'success', 5000);
				}
				else if (xhttp.responseText.substring(0,3) == "099") {
					firework.launch('Configuration updated, but cannot get applied. No flow task running', 'danger', 5000);
				}
			}
		}
		xhttp.open("GET", url, true);
		xhttp.send();
}

 
LoadConfigNeu();
 
</script>
 
</body>
</html>
