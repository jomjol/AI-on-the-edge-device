<!DOCTYPE html>
<html lang="en" xml:lang="en"> 
<head>
    <title>Reference Image</title>
    <meta charset="utf-8"/>
        
    <style>
        h1 {font-size: 2em;}
        h2 {font-size: 1.5em; margin-block-start: 0.0em; margin-block-end: 0.2em;}
        h3 {font-size: 1.2em;}
        p {font-size: 1em;}

        input[type=number] {
            width: 60px;
            margin-right: 10px;
            padding: 3px 5px;
            display: inline-block;
            border: 1px solid #ccc;
            font-size: 16px;
            vertical-align: middle;
        }

		input:out-of-range {
			background-color: rgba(255, 0, 0, 0.25);
			border: 1px solid red;
        }

		input:invalid {
			background-color: rgba(255, 0, 0, 0.25);
			border: 1px solid red;
        }

        .button {
            padding: 5px 10px;
            width: 205px;
            font-size: 16px;
        }

        th, td {
            padding: 5px 5px 5px 0px;
        }

        table {
            width: 660px;
            padding: 5px;
        }
    </style>

    <link href="firework.css?v=019069c" rel="stylesheet">
    <script type="text/javascript" src="jquery-3.6.0.min.js?v=019069c"></script>  
    <script type="text/javascript" src="firework.js?v=019069c"></script>
</head>

<body style="font-family: arial; padding: 0px 10px;">
    <h2>Reference Image</h2>
    <details id="desc_details" style="font-size:16px">
        <summary><b>CLICK HERE</b> for usage description. More infos in documentation: 
                <a href=https://jomjol.github.io/AI-on-the-edge-device-docs/Reference-Image/ target=_blank>Reference Image</a>
        </summary>
        <p>
            The reference image is the base image on which the alignment markers, digit ROIs and anlog ROIs will be defined.
        </p>        
        <p>
            Firstly the actual saved reference image is shown. If you start with the setup from scratch a default image is shown as placeholder.
            Use the button <b>"Create New Reference"</b> to start creation of your own reference image. After selecting the button a new image will be taken
            all configured parameter will be applied to the shown image. With the button <b>"Update Image"</b> you can update the image again (still all parameter
            get applied to the new image).
        </p>        
        <p>
            To have reliable evaluation processing a properly horizontal aligned evaluation area is mandatory. Using the parameters "Rotation angle" and
            "Rotation angle (Fine-tune)" the image can be rotated in both directions. The resulting rotation anlge is used to prerotate the image before
            the alignment algorithm is processed to compensate only small misalignments. Further information can be found in documenation:
            <a href=https://jomjol.github.io/AI-on-the-edge-device-docs/Reference-Image/ target=_blank>Reference Image</a>
        </p>
        <p>
            After setting up your reference image don't forget to save with the <b>"Save New Reference"</b> button!<br>
            <b>NOTE:</b> There is no need to perform a reboot after every saving or step. It's sufficient to reboot after all configuration steps 
            (reference image, alignment, ROI configuration) are completed to activate new configuration.
        </p>
    </details>
    <hr />

	<table>
        <colgroup>
            <col span="1" style="width: 33.3%;">
            <col span="1" style="width: 33.3%;">
            <col span="1" style="width: 33.3%;">
        </colgroup>
        <tr>
            <td><input class="button" type="button" id="orignReference" value="Show Actual Reference" onclick="showReference(param)"></td>	  
            <td><input class="button" type="button" id="newReference" value="Create New Reference" onclick="doTakeReference()"></td>
            <td><input class="button" type="button" id="updateReference" value="Update Image" onclick="doTakeReference()">
        </tr>
    </table>
    <table>
        <colgroup>
            <col span="1" style="width: 32%;">
            <col span="1" style="width: 28%;">
            <col span="1" style="width: 18%;">
            <col span="1" style="width: 22%;">
        </colgroup>
        <tr>
            <td><label for="mirror" id="labelmirror">Mirror image:</label></td>
            <td><input type="checkbox" id="mirror" name="mirror" value="1" onchange="drawRotated()"></td>
            <td>
                <class id="TakeImage_LEDIntensity_text" style="color:black;">LED intensity:</class>
            </td>
            <td>
                <input required style="clear: both" type="number" id="TakeImage_LEDIntensity_value1" size="13" value="0"  min="0" max="100" 
                    oninput="(!validity.rangeOverflow||(value=100)) && (!validity.rangeUnderflow||(value=0)) && 
                        (!validity.stepMismatch||(value=parseInt(this.value)));">
            </td>
        </tr>
        <tr>
            <td><label for="flip" id="labelflip">Flip image size:</label></td>
            <td><input type="checkbox" id="flip" name="flip" value="1" onchange="drawRotated()"></td>
            <td>
                <class id="TakeImage_Brightness_text" style="color:black;">Brightness:</class>
            </td>
            <td>
                <input style="clear: both; width: 80%;vertical-align:middle" type="range" id="TakeImage_Brightness_value1" size="13" value=0  min="-2" max="2" oninput="this.nextElementSibling.value = this.value">
                <output id="TakeImage_Brightness_value1_output" style="vertical-align:middle; min-width:15px; padding-right:5px; text-align:right; float:left">0</output>
            </td>
        </tr>
        <tr>
            <td><label for="prerotateangle">Rotation angle:</label></td>	  
            <td>
                <input required type="number" id="prerotateangle" name="prerotateangle" value="0" min="-360" max="360" onchange="drawRotated()"
                        oninput="(!validity.rangeOverflow||(value=360)) && (!validity.rangeUnderflow||(value=-360)) && 
                            (!validity.stepMismatch||(value=parseInt(this.value)));">degree
                </td>
            <td>
                <class id="TakeImage_Contrast_text" style="color:black;">Contrast:</class>
            </td>
            <td>
                <input style="clear: both; width: 80%;vertical-align:middle" type="range" id="TakeImage_Contrast_value1" size="13" value=0  min="-2" max="2" oninput="this.nextElementSibling.value = this.value">
                <output id="TakeImage_Contrast_value1_output" style="vertical-align:middle; min-width:15px; padding-right:5px; text-align:right; float:left">0</output>
            </td>
        </tr>
        <tr>
            <td><label for="finerotate">Rotation angle (Fine-tune):</label></td>	
            <td>
                <input required type="number" id="finerotate" name="finerotate" value=0.0 min="-1" max="1" step="0.1" onchange="drawRotated()"
                        oninput="(!validity.rangeOverflow||(value=1)) && (!validity.rangeUnderflow||(value=-1)) && 
                            (!validity.stepMismatch||(value=parseInt(this.value)));">degree
            </td>
            <td>
                <class id="TakeImage_Saturation_text" style="color:black;">Saturation:</class>
            </td>
            <td>
                <input  style="clear: both; width: 80%;vertical-align:middle" type="range" id="TakeImage_Saturation_value1" size="13" value=0 min="-2" max="2" oninput="this.nextElementSibling.value = this.value">
                <output id="TakeImage_Saturation_value1_output" style="vertical-align:middle; min-width:15px; padding-right:5px; text-align:right; float:left">0</output>
            </td>
        </tr>
    </table>
    <table>
        <colgroup>
            <col span="1" style="width: 33.3%;">
            <col span="1" style="width: 33.3%;">
            <col span="1" style="width: 33.3%;">
        </colgroup>
        <tr>
            <td style="vertical-align: bottom;"><b>Reference Image:</b></td>
            <td></td>
            <td>
                <input class="button" type="button" id="saveReference" value="Save New Reference" onclick="SaveReference()">
            </td>
        </tr>
        <tr>
            <td colspan="3"><canvas id="canvas"></canvas></td>
        </tr>	
    </table>


    <script type="text/javascript" src="common.js?v=019069c"></script> 
    <script type="text/javascript" src="readconfigcommon.js?v=019069c"></script>  
    <script type="text/javascript" src="readconfigparam.js?v=019069c"></script>  
    
    
    <script language="JavaScript">
        var canvas = document.getElementById('canvas'),
            ctx = canvas.getContext('2d'),
            imageObj = new Image(),
            isActReference = false,
			param_temp,
            param;

       
        function doReboot() {
            if (confirm("Are you sure you want to reboot? Did you save the config?")) {
                    var stringota = getDomainname() + "/reboot";
                    window.location = stringota;
                    window.location.href = stringota;
                    window.location.assign(stringota);
                    window.location.replace(stringota);
            }
        }


		// Create New Reference, Update Image
        function doTakeReference(){ 
            var xhttp = new XMLHttpRequest();
			var domainname = getDomainname();
			
			var _intensity = "";
			var _brightness = "";
			var _contrast = "";
			var _saturation = "";			
			
            _intensity = document.getElementById("TakeImage_LEDIntensity_value1").value;
				
            if (_intensity == "") {
				_intensity = "50";
			}
				
            _brightness = document.getElementById("TakeImage_Brightness_value1").value;
            _contrast = document.getElementById("TakeImage_Contrast_value1").value;
            _saturation = document.getElementById("TakeImage_Saturation_value1").value;
			
			param["TakeImage"]["LEDIntensity"].value1 = _intensity;
			param["TakeImage"]["Brightness"].value1 = _brightness;
			param["TakeImage"]["Contrast"].value1 = _contrast;
			param["TakeImage"]["Saturation"].value1 = _saturation;		
				
            url = domainname + "/editflow?task=test_take";
            url = url + "&bri=" + _brightness + "&con=" + _contrast + "&sat=" + _saturation + "&int=" + _intensity;
			
            if (domainname.length > 0){
                url = url + "&host=" + domainname;
            }

            xhttp.open("GET", url, false);
            xhttp.send();

            firework.launch('Taking updated image...', 'success', 5000);
			
            url = domainname + "/img_tmp/raw.jpg" + "?session=" + Math.floor((Math.random() * 1000000) + 1);
			
            document.getElementById("saveReference").disabled = false;

            document.getElementById("finerotate").disabled = false;
            document.getElementById("prerotateangle").disabled = false;
			document.getElementById("orignReference").disabled = false;
            document.getElementById("newReference").disabled = true;
            document.getElementById("updateReference").disabled = false;
			
            if (param["Alignment"]["InitialMirror"].found) {
                document.getElementById("mirror").disabled = false;
			}
            else {
                document.getElementById("labelmirror").style = "color:lightgrey;";
            }

            if (param["Alignment"]["FlipImageSize"].found) {
                document.getElementById("flip").disabled = false;
			}
            else {
                document.getElementById("labelflip").style = "color:lightgrey;";
            }

            document.getElementById("TakeImage_Brightness_value1").disabled = false;
            document.getElementById("TakeImage_Contrast_value1").disabled = false;
            document.getElementById("TakeImage_Saturation_value1").disabled = false;
            document.getElementById("TakeImage_LEDIntensity_value1").disabled = false;

            isActReference = false;
            loadCanvas(url, true);
			camSettingsSet(param_temp);
        }
		
		
		function camSettingsSet(_param){
			var xhttp = new XMLHttpRequest();
			
			var _brightness = _param["TakeImage"]["Brightness"].value1;
			var _contrast = _param["TakeImage"]["Contrast"].value1;
			var _saturation = _param["TakeImage"]["Saturation"].value1;
			var _intensity = _param["TakeImage"]["LEDIntensity"].value1;

			var url = getDomainname() + "/editflow?task=cam_settings";
			url = url + "&bri=" + _brightness + "&con=" + _contrast + "&sat=" + _saturation + "&int=" + _intensity;

			xhttp.open("GET", url, false);
			xhttp.send();
		}		
		

		// wird von init() und SaveReference() benutzt
        function showReference(_param){
			var domainname = getDomainname();
		
            url = domainname + "/fileserver/config/reference.jpg" + "?session=" + Math.floor((Math.random() * 1000000) + 1);

            if (_param["Alignment"]["InitialRotate"].value1 < 0) {
                document.getElementById("prerotateangle").value = Math.ceil(_param["Alignment"]["InitialRotate"].value1);
            }
            else {
                document.getElementById("prerotateangle").value = Math.floor(_param["Alignment"]["InitialRotate"].value1);
            }

            document.getElementById("finerotate").value = (Number(_param["Alignment"]["InitialRotate"].value1) - 
                                                            Number(document.getElementById("prerotateangle").value)).toFixed(1);

            if (_param["Alignment"]["InitialMirror"].value1 == "true") {
                document.getElementById("mirror").checked = true;
			}
			else {
				document.getElementById("mirror").checked = false;
			}

            if (_param["Alignment"]["FlipImageSize"].value1 == "true") {
                document.getElementById("flip").checked = true;
			}
			else {
				document.getElementById("flip").checked = false;
			}			

			document.getElementById("TakeImage_LEDIntensity_value1").value = _param["TakeImage"]["LEDIntensity"].value1;
			
			document.getElementById("TakeImage_Brightness_value1").value = _param["TakeImage"]["Brightness"].value1;
			document.getElementById("TakeImage_Brightness_value1_output").value = _param["TakeImage"]["Brightness"].value1;
			
			document.getElementById("TakeImage_Contrast_value1").value = _param["TakeImage"]["Contrast"].value1;
			document.getElementById("TakeImage_Contrast_value1_output").value = _param["TakeImage"]["Contrast"].value1;
			
			document.getElementById("TakeImage_Saturation_value1").value = _param["TakeImage"]["Saturation"].value1;
			document.getElementById("TakeImage_Saturation_value1_output").value = _param["TakeImage"]["Saturation"].value1;

            document.getElementById("finerotate").disabled = true;
            document.getElementById("prerotateangle").disabled = true; 
            document.getElementById("saveReference").disabled = true;
			document.getElementById("orignReference").disabled = true;
            document.getElementById("newReference").disabled = false;
            document.getElementById("updateReference").disabled = true;
            document.getElementById("TakeImage_Brightness_value1").disabled = true;
            document.getElementById("TakeImage_Saturation_value1").disabled = true;
            document.getElementById("TakeImage_Contrast_value1").disabled = true;
            document.getElementById("TakeImage_LEDIntensity_value1").disabled = true;
            document.getElementById("mirror").disabled = true;
            document.getElementById("flip").disabled = true;

            isActReference = true;                                  
            loadCanvas(url, false);
        }
        
        
        function dataURLtoBlob(dataurl) {
            var arr = dataurl.split(',');
			var mime = arr[0].match(/:(.*?);/)[1];
            var bstr = atob(arr[1]);
			var n = bstr.length;
			var u8arr = new Uint8Array(n);
				
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
			
            return new Blob([u8arr], {type:mime});
        }			
        
        
        function SaveReference(){
            if (confirm("Are you sure you want to save the new reference image configuration?")) {
				var domainname = getDomainname();
			
                param["Alignment"]["InitialRotate"].value1 = (Number(document.getElementById("prerotateangle").value) + 
                                                                Number(document.getElementById("finerotate").value)).toFixed(1);

                if (document.getElementById("mirror").checked) {
                    param["Alignment"]["InitialMirror"].value1 = "true";
                }
                else {
                    param["Alignment"]["InitialMirror"].value1 = "false";
				}

                if (document.getElementById("flip").checked) {
                    param["Alignment"]["FlipImageSize"].value1 = "true";
				}
                else {
                    param["Alignment"]["FlipImageSize"].value1 = "false";
				}

                var canvas = document.getElementById("canvas");
                drawRotated(false);

                WriteConfigININew();
                SaveConfigToServer(domainname);    
                document.getElementById("saveReference").disabled = true;

                SaveCanvasToImage(canvas, "/config/reference.jpg", true, domainname);
                showReference(param);
                
				param_temp = param;
				camSettingsSet(param);
                firework.launch('Reference image configuration saved', 'success', 5000);
            }
        }


        function loadCanvas(dataURL, grid) {
            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');

            imageObj.onload = function() {
                canvas.width = this.width;
                canvas.height = this.height;
                
				if (grid) {
                    drawRotated(true);
				}
                else {
                    drawRotated(false);
				}
            };

            imageObj.src = dataURL;
        }


        function getCoords(elem) { 
			// crossbrowser version
            var box = elem.getBoundingClientRect();
            var body = document.body;
            var docEl = document.documentElement;
            var scrollTop = window.pageYOffset || docEl.scrollTop || body.scrollTop;
            var scrollLeft = window.pageXOffset || docEl.scrollLeft || body.scrollLeft;
            var clientTop = docEl.clientTop || body.clientTop || 0;
            var clientLeft = docEl.clientLeft || body.clientLeft || 0;
            var top  = box.top +  scrollTop - clientTop;
            var left = box.left + scrollLeft - clientLeft;
			
            return { top: Math.round(top), left: Math.round(left) };
        }

        
        function openDescription() {
			if(window.location.hash) {
				var hash = window.location.hash.substring(1);
				
				if(hash == 'description') {
					document.getElementById("desc_details").open = true;
				}
			}
        }
    

        function init() {
            openDescription();
            canvas.addEventListener('mousemove', mouseMove, false);
			
            loadConfig(getDomainname()); 
            ParseConfig();
            param = getConfigParameters();
			param_temp = param;

            if (!param["TakeImage"]["LEDIntensity"]["found"]) {
                param["TakeImage"]["LEDIntensity"]["found"] = true;
                param["TakeImage"]["LEDIntensity"]["value1"] = "50";
            }
			
            if (!param["TakeImage"]["Brightness"]["found"]) {
                param["TakeImage"]["Brightness"]["found"] = true;
                param["TakeImage"]["Brightness"]["value1"] = "0";
            }		
			
            if (!param["TakeImage"]["Contrast"]["found"]) {
                param["TakeImage"]["Contrast"]["found"] = true;
                param["TakeImage"]["Contrast"]["value1"] = "0";
            }		
			
            if (!param["TakeImage"]["Saturation"]["found"]) {
                param["TakeImage"]["Saturation"]["found"] = true;
                param["TakeImage"]["Saturation"]["value1"] = "0";
            }			

            showReference(param); 
        }
        

        function drawRotated(_grid = true) {
            finerot= parseFloat(document.getElementById("finerotate").value);
            prerot = parseFloat(document.getElementById("prerotateangle").value);
            mirror = document.getElementById("mirror").checked;
            flip = document.getElementById("flip").checked;

            if (finerot == 1) {
                prerot+=1
                finerot = 0
            }
			
            if (finerot == -1) {
                prerot-=1
                finerot = 0
            }
			
            degrees = finerot + prerot;
            document.getElementById("finerotate").value =  finerot;
            document.getElementById("prerotateangle").value =  prerot;

            var canvas = document.getElementById('canvas');
			
            if (flip == 1) {
                canvas.width = imageObj.height;
                canvas.height = imageObj.width;
            }
            else {
                canvas.width = imageObj.width;
                canvas.height = imageObj.height;
            }

            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');

            context.clearRect(0,0,canvas.width,canvas.height);
            context.save();

            if (isActReference) {
                context.drawImage(imageObj,0,0);
            }
            else {
                context.translate(canvas.width/2,canvas.height/2);
                context.rotate(degrees*Math.PI/180);
				
                if (mirror) {
                    context.scale(-1, 1);
                }
				
                context.drawImage(imageObj,-imageObj.width/2,-imageObj.height/2);
            }
            
            context.restore();

            if (_grid) {
                drawGrid();
			}
        }


        function drawGrid(){
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
            w = canvas.width;
            h = canvas.height;
            ctx.save();
            ctx.strokeStyle = '#00FF00';

            for (i = h/2; i < h; i += 100) {
                ctx.moveTo(0, i);
                ctx.lineTo(w, i);
                ctx.stroke();
                ctx.moveTo(0, h-i);
                ctx.lineTo(w, h-i);
                ctx.stroke();
            }
			
            for (i = w/2; i < w; i += 100) {
                ctx.moveTo(i, 0);
                ctx.lineTo(i, h);
                ctx.stroke();
                ctx.moveTo(w-i, 0);
                ctx.lineTo(w-i, h);
                ctx.stroke();                
			}
			
            ctx.restore();
        }


        function mouseMove(e) {
            if (isActReference) {
                drawRotated(false);
			}
            else {
                drawRotated(true);
			}
            
            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');

            zw = getCoords(this);
            x = e.pageX - zw.left;
            y = e.pageY - zw.top;
            
            context.lineWidth = 2;
            context.strokeStyle = "#00FF00";
            context.beginPath(); 
            context.moveTo(0,y);
            context.lineTo(canvas.width, y);
            context.moveTo(x, 0);
            context.lineTo(x, canvas.height);
            context.stroke();            
        }

        init();
    
    </script>

</body>
</html>
